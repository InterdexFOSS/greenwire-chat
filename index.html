<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GreenWire Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050805;
      --panel: #0b120b;
      --green: #00ff88;
      --green-dim: #00aa66;
      --text: #d7ffe9;
      --border: #123d2a;
    }

    * { box-sizing: border-box; font-family: system-ui, monospace; }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #0a140f, var(--bg));
      color: var(--text);
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .app {
      width: 95%;
      max-width: 900px;
      height: 90vh;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 0 40px rgba(0,255,136,0.15);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--green);
      font-weight: 600;
    }

    .screen {
      flex: 1;
      display: none;
      padding: 20px;
    }

    .screen.active { display: block; }

    .center {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 400px;
      margin: 60px auto;
    }

    input, button {
      background: #050805;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px;
      border-radius: 6px;
      font-size: 15px;
    }

    input::placeholder { color: #6fae91; }

    button {
      cursor: pointer;
      color: var(--green);
      border-color: var(--green-dim);
    }

    button:hover { background: #08130c; }

    .chat {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding-right: 6px;
    }

    .msg {
      margin-bottom: 10px;
      padding: 8px 10px;
      border-left: 3px solid var(--green-dim);
      background: #060e09;
      border-radius: 4px;
      opacity: 1;
    }

    .msg .name {
      color: var(--green);
      font-weight: 600;
      font-size: 13px;
    }

    .msg .text {
      font-size: 14px;
      white-space: pre-wrap;
    }

    /* fade-out effect after 1 minute */
    .msg.fade {
      opacity: 0;
      transition: opacity 0.6s ease;
    }

    .inputbar {
      display: flex;
      gap: 8px;
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }

    .inputbar input[type="text"] { flex: 1; }

    footer {
      font-size: 11px;
      opacity: 0.6;
      padding: 6px 10px;
      border-top: 1px solid var(--border);
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <span>GreenWire · Room: <span id="roomTag">—</span></span>
      <span id="userTag"></span>
    </header>

    <!-- NAME SCREEN -->
    <div class="screen active" id="screen-name">
      <div class="center">
        <h2>Enter a temporary name</h2>
        <input id="nameInput" placeholder="anonymous" maxlength="20" />
        <button onclick="setName()">Enter</button>
      </div>
    </div>

    <!-- ROOM SCREEN -->
    <div class="screen" id="screen-room">
      <div class="center">
        <h2>Join or create a chat</h2>
        <input id="roomInput" placeholder="Chat code (or generate one)" />
        <button onclick="joinRoom()">Connect</button>
        <button onclick="generateAndJoin()">Generate Chat</button>
        <p style="opacity:.6">Owner code: <b>Own3r</b></p>
      </div>
    </div>

    <!-- CHAT SCREEN -->
    <div class="screen" id="screen-chat">
      <div class="chat">
        <div class="messages" id="messages"></div>
        <div class="inputbar">
          <input id="msgInput" type="text" placeholder="Type a message..." />
          <input id="fileInput" type="file" />
          <button onclick="sendMsg()">Send</button>
        </div>
      </div>
    </div>

    <footer>Session-only profile · No accounts · Dark Green Network</footer>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ---------- SUPABASE CLIENT ----------
      const supabaseUrl = 'https://bqwdogueiqutcqsdxhuk.supabase.co';
      const supabaseKey = 'sb_publishable_AdKx8RYpbDdfUGe-iiktHQ_Ua_BVfnE';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      // ---------- DOM ELEMENTS ----------
      const nameInput   = document.getElementById('nameInput');
      const roomInput   = document.getElementById('roomInput');
      const msgInput    = document.getElementById('msgInput');
      const messagesEl  = document.getElementById('messages');
      const userTag     = document.getElementById('userTag');
      const roomTag     = document.getElementById('roomTag');

      // ---------- STATE ----------
      let username = null;
      let room = null;
      let supabaseChannel = null;

      // Expose functions for inline onclick
      window.setName = setName;
      window.joinRoom = joinRoom;
      window.generateAndJoin = generateAndJoin;
      window.sendMsg = sendMsg;

      function generateRoom() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
      }

      function generateAndJoin() {
        roomInput.value = generateRoom();
        joinRoom();
      }

      function show(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
      }

      function setName() {
        const val = nameInput.value.trim() || 'anonymous';
        username = val;
        userTag.textContent = username;
        show('screen-room');
      }

      async function joinRoom() {
        const val = (roomInput.value.trim() || generateRoom()).toUpperCase();
        room = val;
        roomTag.textContent = room;
        show('screen-chat');

        // Clear existing messages
        messagesEl.innerHTML = '';

        // Load previous messages from Supabase
        const { data, error } = await supabase
          .from('messages')
          .select('*')
          .eq('room', room)
          .order('inserted_at', { ascending: true });

        if (error) {
          console.error('Error loading messages:', error);
          addMsg('SYSTEM', 'Error loading previous messages.');
        } else {
          data.forEach(m => addMsg(m.username, m.content));
        }

        addMsg('SYSTEM', `Joined room: ${room}`);

        // Unsubscribe previous channel if any
        if (supabaseChannel) {
          supabase.removeChannel(supabaseChannel);
        }

        // Realtime subscription for this room
        supabaseChannel = supabase
          .channel('room-' + room)
          .on(
            'postgres_changes',
            { event: 'INSERT', schema: 'public', table: 'messages', filter: `room=eq.${room}` },
            payload => {
              const m = payload.new;
              // Avoid duplicating our own message if it’s already visible
              addMsg(m.username, m.content);
            }
          )
          .subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
              console.log('Realtime subscribed to room', room);
            }
          });
      }

      async function sendMsg() {
        const text = msgInput.value.trim();
        if (!text) return;
        if (!username) {
          alert('Set a name first.');
          return;
        }
        if (!room) {
          alert('Join a room first.');
          return;
        }

        const { error } = await supabase
          .from('messages')
          .insert([{ room, username, content: text }]);

        if (error) {
          console.error('Error sending message:', error);
          addMsg('SYSTEM', 'Error sending message.');
          return;
        }

        // We rely on realtime to deliver the message to all clients, including us.
        msgInput.value = '';
      }

      function addMsg(name, text) {
        if (!messagesEl) return;

        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<div class="name">${name}</div><div class="text">${text}</div>`;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;

        // fade out after 60 seconds and remove
        const fadeMs = 60000;
        const removeDelayMs = 800;

        setTimeout(() => {
          div.classList.add('fade');
        }, fadeMs);

        setTimeout(() => {
          if (div.parentNode) {
            div.parentNode.removeChild(div);
          }
        }, fadeMs + removeDelayMs);
      }
    });
  </script>
</body>
</html>
